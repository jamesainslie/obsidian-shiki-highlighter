name: Release Plugin

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: Release Obsidian Plugin
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npx eslint src --ext .ts

      - name: Run tests
        run: npm test

      - name: Build plugin
        run: npm run build

      - name: Check bundle size
        run: |
          SIZE=$(stat -f%z main.js 2>/dev/null || stat -c%s main.js)
          SIZE_MB=$(echo "scale=2; $SIZE/1048576" | bc)
          echo "Bundle size: $SIZE bytes ($SIZE_MB MB)"
          if [ $SIZE -gt 10485760 ]; then
            echo "Warning: Bundle size ($SIZE bytes) exceeds 10MB"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'rc') || contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
          generate_release_notes: true
          files: |
            main.js
            manifest.json
            styles/styles.css
          body: |
            ## Shiki Syntax Highlighter v${{ steps.version.outputs.version }}
            
            ### Installation
            
            #### From Obsidian Community Plugins
            
            1. Open Obsidian Settings
            2. Go to Community Plugins and disable Safe Mode
            3. Click Browse and search for "Shiki Syntax Highlighter"
            4. Click Install, then Enable
            
            #### Manual Installation
            
            1. Download `main.js`, `manifest.json`, and `styles.css` from the assets below
            2. Create a folder: `<vault>/.obsidian/plugins/shiki-highlighter/`
            3. Copy the downloaded files into this folder
            4. Reload Obsidian
            5. Enable the plugin in Settings > Community Plugins
            
            ### Changes
            
            See the full changelog below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugin-files
          path: |
            main.js
            manifest.json
            styles/styles.css

